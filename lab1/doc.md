# Лабораторная работа №1: Реализация серверного приложения на FastAPI

## 1. Описание

Данная лабораторная работа посвящена созданию серверного приложения для управления поездками с использованием фреймворка FastAPI, ORM SQLModel и JSON Web Token (JWT) для аутентификации.

С помощью API пользователь может:

* Регистрироваться и входить в систему (JWT-аутентификация).
* Создавать, просматривать, обновлять и удалять поездки.
* Присоединяться к поездкам и покидать их.
* Управлять маршрутом поездки.

## 2. Структура проекта

```
project_root/
├── app/
│   ├── connection.py       # инициализация БД и сессий
│   ├── models.py           # описания моделей SQLModel и DTO
│   └── main.py             # настройки FastAPI, роуты, бизнес-логика
├── .env                    # переменные окружения (DATABASE_URL)
└── requirements.txt        # зависимости проекта
```

## 3. Установка и запуск

1. Клонировать репозиторий:

   ```bash
   git clone <repository_url>
   cd project_root
   ```
2. Создать виртуальное окружение и установить зависимости:

   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/macOS
   venv\Scripts\activate     # Windows
   pip install -r requirements.txt
   ```
3. Настроить переменные окружения в файле `.env`:

   ```env
   DB_ADMIN=postgresql://user:password@localhost:5432/your_db_name
   ```
4. Запустить приложение:

   ```bash
   uvicorn app.main:app --reload
   ```

По умолчанию сервер будет доступен по адресу: `http://127.0.0.1:8000`.

## 4. Конфигурация CORS

В `main.py` настроен middleware CORS:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:5173","http://127.0.0.1:5173"],
    allow_methods=["GET","POST","PUT","PATCH","DELETE","OPTIONS"],
    allow_headers=["*"],
)
```

Это позволяет фронтенду (например, на Vite/Vue/React) взаимодействовать с API.

## 5. Инициализация базы данных

В `app.connection.init_db()` создаются все таблицы, описанные в `models.py`. Функция вызывается автоматически при старте приложения через событие `startup`.

## 6. Модели данных

В файле `app.models.py` определены две группы моделей:

1. **SQLModel-тables** (ORM-модели):

   * `UserProfile` — пользователь с полями id, username, hashed\_password, full\_name, bio, preferences
   * `Trip` — поездка с полями id, title, description, start\_date, end\_date, origin, destination, duration\_days, owner\_id
   * `TripParticipantLink` — связь многие-ко-многим между поездками и пользователями
   * `ItineraryItem` — элемент маршрута (день, локация, описание)
   * `Message` — сообщение внутри поездки (sender, content, timestamp)
2. **DTO-модели** (для создания сущностей в запросах):

   * `UserCreate`, `TripCreate`, `ItineraryItemCreate`, `MessageCreate`

## 7. Аутентификация

Для регистрации и входа реализованы эндпоинты:

| Метод | URL         | Описание                                            |
| ----- | ----------- | --------------------------------------------------- |
| POST  | `/register` | Регистрация нового пользователя, возвращает профиль |
| POST  | `/login`    | Вход по форме OAuth2, возвращает JWT-токен          |

Пароли хранятся в базе в виде SHA-256-хеша. JWT-токен создаётся с `user_id` и временем жизни (60 минут).
Для защищённых эндпоинтов используется Depends `get_current_user`, который извлекает и валидирует токен.

## 8. CRUD для поездок

| Метод  | URL                | Описание                      | Права доступа         |
| ------ | ------------------ | ----------------------------- | --------------------- |
| POST   | `/trips`           | Создать новую поездку         | Только авторизованные |
| GET    | `/trips`           | Список всех поездок           | Открытый              |
| GET    | `/trips/{trip_id}` | Получить детали поездки по ID | Открытый              |
| PATCH  | `/trips/{trip_id}` | Обновить данные поездки       | Владелец поездки      |
| DELETE | `/trips/{trip_id}` | Удалить поездку               | Владелец поездки      |

Пример создания поездки:

```bash
curl -X POST http://127.0.0.1:8000/trips \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"title":"Путешествие","start_date":"2025-06-01","end_date":"2025-06-10","origin":"Москва","destination":"Санкт-Петербург"}'
```

## 9. Управление участниками поездки

| Метод  | URL                      | Описание                 | Права доступа  |
| ------ | ------------------------ | ------------------------ | -------------- |
| POST   | `/trips/{trip_id}/join`  | Присоединиться к поездке | Авторизованные |
| DELETE | `/trips/{trip_id}/leave` | Выйти из поездки         | Авторизованные |

## 10. Маршрут (Itinerary)

| Метод  | URL                                    | Описание                         | Права доступа           |
| ------ | -------------------------------------- | -------------------------------- | ----------------------- |
| POST   | `/trips/{trip_id}/itinerary`           | Создать пункт маршрута           | Только владелец поездки |
| GET    | `/trips/{trip_id}/itinerary`           | Получить список пунктов маршрута | Открытый                |
| DELETE | `/trips/{trip_id}/itinerary/{item_id}` | Удалить пункт маршрута           | Только владелец поездки |

## 11. Сообщения (Messaging)

| Метод | URL                         | Описание                       | Права доступа  |
| ----- | --------------------------- | ------------------------------ | -------------- |
| POST  | `/trips/{trip_id}/messages` | Отправить сообщение в поездке  | Авторизованные |
| GET   | `/trips/{trip_id}/messages` | Получить все сообщения поездки | Открытый       |

Пример отправки сообщения:

```bash
curl -X POST http://127.0.0.1:8000/trips/1/messages \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"content":"Привет, команда!"}'
```

## 12. Заключение

Данное приложение демонстрирует основы построения RESTful API с FastAPI, включая:

* Авторизацию и аутентификацию с JWT
* CRUD-операции с моделями SQLModel
* Связи "один-ко-многим" и "многие-ко-многим"
* Обмен сообщениями и управление ресурсами
